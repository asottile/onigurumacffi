#!/usr/bin/env python3
import argparse
import os
import shutil
import subprocess

IMG = 'onigurumacffi-build'
# TODO: switch back to a tag
REV = '50f78810ab0ab2b19c6caecf91a2043fde87c2ea'
DOCKERFILE = f'''\
FROM quay.io/pypa/manylinux1_x86_64:latest
RUN : \
    && git init oniguruma \
    && cd oniguruma \
    && git remote add origin https://github.com/kkos/oniguruma \
    && git -c protocol.version=2 fetch --depth 1 origin {REV} \
    && git checkout FETCH_HEAD \
    && ./autogen.sh \
    && ./configure \
    && make -j4 install \
    && cd .. \
    && rm -rf oniguruma
'''


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument('version')
    args = parser.parse_args()

    pkg = f'onigurumacffi=={args.version}'

    shutil.rmtree('dist', ignore_errors=True)
    os.makedirs('dist', exist_ok=True)

    cmd = ('docker', 'build', '-t', IMG, '-')
    subprocess.run(cmd, input=DOCKERFILE.encode(), check=True)

    PROG = f'''\
/opt/python/cp36-cp36m/bin/pip wheel --wheel-dir /work --no-deps {pkg} &&
auditwheel repair --wheel-dir /dist /work/*.whl &&
ls /dist/*.whl &&
unzip -l /dist/*.whl
'''

    return subprocess.call((
        'docker', 'run',
        '--volume', f'{os.path.abspath("dist")}:/dist:rw',
        '--rm', '-ti', IMG, 'bash', '-euxc', PROG,
    ))


if __name__ == '__main__':
    exit(main())
